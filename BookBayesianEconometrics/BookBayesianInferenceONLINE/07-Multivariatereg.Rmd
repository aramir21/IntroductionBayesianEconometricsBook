# Multivariate regression {#Chap7}

We describe how to perform Bayesian inference in multivariate response models, including multivariate regression, seemingly unrelated regression, instrumental variables, and the multivariate probit model. In particular, we present the posterior distributions of the parameters and demonstrate several applications and simulations. Additionally, we show how to perform inference in these models using three levels of programming skills: GUI, packages, and programming the algorithms from scratch. Finally, we provide some mathematical and computational exercises.

Remember that we can run our GUI typing `shiny::runGitHub("besmarter/BSTApp", launch.browser=T)` in the **R** console or any **R** code editor and execute it. However, users should see Chapter \@ref(Chap5) for details.

## Multivariate regression {#sec71}

A complete presentation of this model is given in Section \@ref(sec44). We show here the setting, and the posterior distributions for facility in exposition. In particular, there are \(M\) multiply dependent variables which share the same set of regressors, and their stochastic errors are contemporaneously correlated. In particular, \(\boldsymbol{Y} = \left[ \boldsymbol{y_{1}} \ \boldsymbol{y_{2}} \ \ldots \ \boldsymbol{y_{M}} \right]\) is an \( N \times M \) matrix that is generated by \(\boldsymbol{Y} = \boldsymbol{X} \boldsymbol{B} + \boldsymbol{U}\) where \(\boldsymbol{X}\) is an \( N \times K \) matrix of regressors, \(\boldsymbol{B} = \left[ \boldsymbol{\beta}_{1} \ \boldsymbol{\beta}_{2} \ldots \boldsymbol{\beta}_{M} \right]\) is a \( K \times M \) matrix of parameters, and \(\boldsymbol{U} = \left[ \boldsymbol{\mu}_{1} \ \boldsymbol{\mu}_{2} \ldots \boldsymbol{\mu}_{M} \right]\) is a matrix of stochastic random errors such that \(\boldsymbol{\mu}_i \sim N(\boldsymbol{0}, \boldsymbol{\Sigma})\), for \(i = 1, 2, \dots, N\), each row of \(\boldsymbol{U}\).

The prior is given by \(\boldsymbol{B} \mid \boldsymbol{\Sigma} \sim N(\boldsymbol{B}_0, \boldsymbol{V}_0, \boldsymbol{\Sigma})\) and \(\boldsymbol{\Sigma} \sim IW(\boldsymbol{\Psi}_0, \alpha_0)\). Therefore, the conditional posterior distributions are:

\[
\boldsymbol{B} \mid \boldsymbol{\Sigma}, \boldsymbol{Y}, \boldsymbol{X} \sim N(\boldsymbol{B}_n, \boldsymbol{V}_n, \boldsymbol{\Sigma}),
\]

\[
\boldsymbol{\Sigma} \mid \boldsymbol{Y}, \boldsymbol{X} \sim IW(\boldsymbol{\Psi}_n, \alpha_n),
\]

where 

\[
\boldsymbol{V}_n = (\boldsymbol{X}^{\top} \boldsymbol{X} + \boldsymbol{V}_0^{-1})^{-1}, \quad 
\boldsymbol{B}_n = \boldsymbol{V}_n (\boldsymbol{V}_0^{-1} \boldsymbol{B}_0 + \boldsymbol{X}^{\top} \boldsymbol{X} \hat{\boldsymbol{B}}),
\]

\[
\hat{\boldsymbol{B}} = (\boldsymbol{X}^{\top} \boldsymbol{X})^{-1} \boldsymbol{X}^{\top} \boldsymbol{Y}, \quad 
\boldsymbol{\Psi}_n = \boldsymbol{\Psi}_{0} + \boldsymbol{S} + \boldsymbol{B}_{0}^{\top} \boldsymbol{V}_{0}^{-1} \boldsymbol{B}_{0} + \hat{\boldsymbol{B}}^{\top} \boldsymbol{X}^{\top} \boldsymbol{X} \hat{\boldsymbol{B}} - \boldsymbol{B}_n^{\top} \boldsymbol{V}_n^{-1} \boldsymbol{B}_n,
\]

and 

\[
\alpha_n = \alpha_0 + N.
\]

We can use a Gibbs sampling algorithm in this model since the conditional posterior distributions are standard.

**Example: The effect of institutions on per capita gross domestic product**

To illustrate multivariate regression models, we use the dataset provided by @Acemoglu2001, who analyzed the effect of property rights on economic growth.

We begin with the following *simultaneous structural* economic model:^[This model captures the potential underlying economic relationship between the variables.]
\begin{align}
	\log(\text{pcGDP95}_i) &= \beta_1 + \beta_2 \text{PAER}_i + \beta_3 \text{Africa} + \beta_4 \text{Asia} + \beta_5 \text{Other} + u_{1i},
	(\#eq:str1)
\end{align}
\begin{align}
	\text{PAER}_i &= \alpha_1 + \alpha_2 \log(\text{pcGDP95}_i) + \alpha_3 \log(\text{Mort}_i) + u_{2i},
	(\#eq:str2)
\end{align}
where *pcGDP95*, *PAER*, and *Mort* represent the per capita gross domestic product (GDP) in 1995, the average index of protection against expropriation between 1985 and 1995, and the settler mortality rate during the period of colonization, respectively. *Africa*, *Asia*, and *Other* are indicator variables for continents, with *America* serving as the baseline group.

In this model, there is *reverse (simultaneous) causality* due to the contemporaneous effect of *GDP* on *PAER*, and vice versa.^[ *Simultaneous causality* is one of the most controversial causation issues from a philosophy of science perspective. The root of the issue is that causation is typically based on the time sequence of cause and effect.] Therefore, estimating Equations \@ref(eq:str1) and \@ref(eq:str2) without accounting for this phenomenon results in posterior mean estimates that are *biased* and *inconsistent* from a sampling (frequentist) perspective.^[Note that $\mathbb{E}[u_1\text{PAER}]\neq 0$, which means failing to meet a necessary condition for obtaining *unbiased* and *consistent* estimators of \boldsymbol{\beta}. See Exercise 1.] A potential strategy to address this issue is to estimate the *reduced-form* model, i.e., a model without *simultaneous causality*, where all *endogenous variables* are functions of *exogenous variables*. The former are determined within the model (e.g., $\log(\text{pcGDP95}_i)$ and *PAER* in this example), while the latter are determined outside the model (e.g., $\log(\text{Mort}_i)$, *Africa*, *Asia*, and *Other* in this example).

Replacing Equation \@ref(eq:str2) into Equation \@ref(eq:str1), and solving for $\log(\textit{pcGDP95})$,
\begin{align}
	\log(\text{pcGDP95}_i)=\pi_1+\pi_2\log(\text{Mort}_i)+\pi_3 \text{Africa}+\pi_4 \text{Asia}+\pi_5 \text{Other}+e_{1i}. 
	(\#eq:red1)
\end{align}
Then, by substituting Equation \@ref(eq:red1) into Equation \@ref(eq:str2), and solving for *PAER*, we obtain
\begin{align}
	\text{PAER}_i = \gamma_1 + \gamma_2 \log(\text{Mort}_i) + \gamma_3 \text{Africa} + \gamma_4 \text{Asia} + \gamma_5 \text{Other} + e_{2i},
	(\#eq:red2)
\end{align}
where $\pi_2 = \frac{\beta_2\alpha_3}{1 - \beta_2\alpha_2}$ and $\gamma_2 = \frac{\alpha_3}{1 - \beta_2\alpha_2}$, given that $\beta_2 \alpha_2 \neq 1$, i.e., independent equations (see Exercise 2).

Observe that Equations \@ref(eq:red1) and \@ref(eq:red2) have the form of a multivariate regression model, where the common set of regressors is 
\[
\boldsymbol{X} = \left[\log(\text{Mort}) \ \text{Africa} \ \text{Asia} \ \text{Other}\right]
\]
and the common set of dependent variables is 
\[
\boldsymbol{Y} = \left[\log(\text{pcGDP95}) \ \text{PAER}\right].
\]
Therefore, we can estimate this model using the setup outlined in this section.

In the first stage, we estimate the parameters of the *reduced-form* model (Equations \@ref(eq:red1) and \@ref(eq:red2)), but the main interest lies in estimating the parameters of the *structural* model (Equations \@ref(eq:str1) and \@ref(eq:str2)). A valid question is whether we can recover (identify) the *structural* parameters from the *reduced-form* parameters. There are two criteria to answer this question: the order condition, which is necessary, and the rank condition, which is both necessary and sufficient.  

**The order condition**

Given a system of equations with \(M\) endogenous variables, and \(K\) exogenous variables (including the intercept), there are two ways to assess the order condition:

- The parameters of an equation in the system are identified if there are at least \(M-1\) variables excluded from the equation (*exclusion restrictions*). The equation is *exactly identified* if the number of excluded variables is \(M-1\), and is *over identified* if the number of excluded variables is greater than \(M-1\).
- The parameters of equation \(m\) in the system are identified if \(K-K_m\geq M_m-1\), where \(K_m\) and \(M_m\) are the number of exogenous and endogenous variables in equation \(m\), respectively. The \(m\)-th equation is *exactly identified* if \(K-K_m = M_m-1\), and *over identified* if \(K-K_m > M_m-1\).

We can see from Equations \@ref(eq:str1) and \@ref(eq:str2) in this example that \(K=5\), \(M=2\), \(K_1=4\), \(K_2=2\), \(M_1=2\), and \(M_2=2\). This means that \(K-K_1=1=M-1\) and \(K-K_2=3>M-1=1\), that is, the order condition says that both equations satisfy the necessary condition of identification, the first equation would be *exactly identified*, and the second equation would be *over identified*. Observe that there is one excluded variable from the first equation, and there are three excluded variables from the second equation.  

**The rank condition**

The rank condition (necessary and sufficient) says that given a *structural* model with \(M\) equations (\(M\) endogenous variables), an equation is identified if and only if there is at least one determinant different from zero from a \((M-1)\times(M-1)\) matrix built using the excluded variables in the analyzed equation, but included in any other equation of the system.

It is useful to build the *identification matrix* to implement the *rank* condition. The next Table shows this matrix in this example.

```{r, echo=FALSE, message=FALSE}
suppressWarnings(library(kableExtra))

# Create the matrix as a data frame
table_data <- data.frame(
  Col1 = c("$\\log(\\text{pcGDP95})$", "1", "$-\\alpha_2$"),
  Col2 = c("$\\text{PAER}$", "$-\\beta_2$", "1"),
  Col3 = c("Constant", "$-\\beta_1$", "$-\\alpha_1$"),
  Col4 = c("$\\log(\\text{Mort})$", "0", "$-\\alpha_3$"),
  Col5 = c("Africa", "$-\\beta_3$", "0"),
  Col6 = c("Asia", "$-\\beta_4$", "0"),
  Col7 = c("Other", "$-\\beta_5$", "0")
)

# Render the table using kableExtra
kbl(table_data, format = "html", escape = FALSE, booktabs = TRUE, col.names = NULL, 
    caption = "Example: Rank condition") %>%
  kable_styling(full_width = FALSE, latex_options = "hold_position")
```

The only excluded variable in the $\log(\text{pcGDP95})$ equation is $\log(\text{Mort})$. Therefore, there is only one matrix that can be constructed using the excluded variables from this equation, which is $[-\alpha_3]$ (see column 4 in the Table). The determinant of this matrix is $-\alpha_3$, and as long as this coefficient is nonzero (i.e., $\alpha_3 \neq 0$), meaning that the mortality rate is relevant in the PAER equation, the coefficients in the $\log(\text{pcGDP95})$ equation are *exactly identified*. For example, $\beta_2 = \frac{\pi_2}{\gamma_2}$, which represents the effect of property rights on GDP, is exactly identified.

It is crucial to observe the importance of excluding $\log(\text{Mort})$ from the $\log(\text{pcGDP95})$ equation, while including $\log(\text{Mort})$ in the PAER equation. This is known as the *exclusion restriction*, which requires the presence of an exogenous source of variability in the PAER equation to help identify the $\log(\text{pcGDP95})$ equation. The presence of relevant exogenous sources of variability is an essential factor in the identification, estimation, and inference of *structural* parameters.

As for the identification of the *structural* parameters in the PAER equation, there are three potential matrices that can be constructed: $[-\beta_3]$, $[-\beta_4]$, and $[-\beta_5]$ (see columns 5, 6, and 7 in the Table). As long as any of these parameters are relevant in the $\log(\text{pcGDP95})$ equation, the PAER equation is identified. In this case, the PAER equation is *over-identified*, meaning there are multiple ways to estimate the parameters in this equation. For example, $\alpha_2 = \gamma_3/\pi_3 = \gamma_4/\pi_4 = \gamma_5/\pi_5$ (see Exercise 2).

In general, recovering the *structural* parameters from the *reduced-form* parameters can be challenging due to the need for relevant identification restrictions, which can be difficult to find in some applications.^[Good introductory-level textbooks on identification in linear systems include @gujarati2009basic, and @wooldridge2016introductory.]

For this example, we set non-informative priors: $\boldsymbol{B}_0 = \left[\boldsymbol{0}_5 \ \boldsymbol{0}_5\right]$, $\boldsymbol{V}_0 = 100 \boldsymbol{I}_K$, $\boldsymbol{\Psi}_0 = 5 \boldsymbol{I}_2$, and $\alpha_0 = 5$.^[Note that we are setting the priors in the *reduced-form* model. This may have unintended consequences for the posterior distributions of the *structural* parameters, which are ultimately the parameters of interest to researchers. For further discussion, see @koop2003bayesian.] Once our GUI is displayed (see the beginning of this chapter), we should follow the next Algorithm to run multivariate linear models in the GUI (see Chapter \@ref(Chap5) for details, particularly on how to set the data set).

::: {.algorithm}
<div style="background-color: #f8f9fa; padding: 15px; border-left: 5px solid #343a40; box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1); border-radius: 5px;">

**Algorithm: Multivariate Linear Model**  

1. Select *Multivariate Models* on the top panel 

2. Select *Simple Multivariate* model using the left radio button 

3. Upload the dataset selecting first if there is header in the file, and the kind of separator in the *csv* file of the dataset (comma, semicolon, or tab). Then, use the *Browse* button under the **Choose File** legend  

4. Select MCMC iterations, burn-in, and thinning parameters using the *Range sliders*

5. Select the number of dependent variables in the box **Number of endogenous variables: m** 

6. Select the number of independent variables (including the intercept) in the box **Number of exogenous variables: k** 

7. Set the hyperparameters: mean vectors, covariance matrix, degrees of freedom, and the scale matrix. This step is not necessary as by default our GUI uses non-informative priors

8. Click the *Go!* button 

9. Analyze results  

10. Download posterior chains and diagnostic plots using the *Download Posterior Chains* and *Download Posterior Graphs* buttons  

</div>
:::

The following **R** code shows how to perform the Gibss sampling algorithm in this example using the dataset *4Institutions.csv*. We ask to run this example using the *rmultireg* command from the *bayesm* package as an exercise. We find that the posterior mean *structural* effect of property rights on GDP is 0.98, and the 95\% credible interval is (0.56, 2.87). This means that there is evidence supporting a positive effect of property rights on gross domestic product. 


```{r}
rm(list = ls())
set.seed(12345)
DataInst <- read.csv("https://raw.githubusercontent.com/besmarter/BSTApp/refs/heads/master/DataApp/4Institutions.csv", sep = ",", header = TRUE, quote = "")
attach(DataInst)
Y <- cbind(logpcGDP95, PAER)
X <- cbind(1, logMort, Africa, Asia, Other)
M <- dim(Y)[2]
K <- dim(X)[2]
N <- dim(Y)[1]
# Hyperparameters
B0 <- matrix(0, K, M)
c0 <- 100
V0 <- c0*diag(K)
Psi0 <- 5*diag(M)
a0 <- 5
# Posterior parameters
Bhat <- solve(t(X)%*%X)%*%t(X)%*%Y 
S <- t(Y - X%*%Bhat)%*%(Y - X%*%Bhat)
Vn <- solve(solve(V0) + t(X)%*%X) 
Bn <- Vn%*%(solve(V0)%*%B0 + t(X)%*%X%*%Bhat)
Psin <- Psi0 + S + t(B0)%*%solve(V0)%*%B0 + t(Bhat)%*%t(X)%*%X%*%Bhat - t(Bn)%*%solve(Vn)%*%Bn
an <- a0 + N
#Posterior draws
s <- 10000 #Number of posterior draws
SIGs <- replicate(s, LaplacesDemon::rinvwishart(an, Psin))
BsCond <- sapply(1:s, function(s) {MixMatrix::rmatrixnorm(n = 1, mean=Bn, U = Vn,V = SIGs[,,s])})
summary(coda::mcmc(t(BsCond)))
SIGMs <- t(sapply(1:s, function(l) {gdata::lowerTriangle(SIGs[,,l], diag=TRUE, byrow=FALSE)}))
summary(coda::mcmc(SIGMs))
hdiBs <- HDInterval::hdi(t(BsCond), credMass = 0.95) # Highest posterior density credible interval
hdiBs
hdiSIG <- HDInterval::hdi(SIGMs, credMass = 0.95) # Highest posterior density credible interval
hdiSIG
beta2 <- BsCond[2,]/BsCond[7,] 
summary(coda::mcmc(beta2)) # Effect of property rights on GDP
```

## Seemingly Unrelated Regression {#sec72}

In seemingly unrelated regression (SUR) models, there are \( M \) dependent variables, each with potentially different regressors, such that the stochastic errors are contemporaneously correlated. The model is given by:

\[
\boldsymbol{y}_m = \boldsymbol{X}_m \boldsymbol{\beta}_m + \boldsymbol{\mu}_m,
\]

where \( \boldsymbol{y}_m \) is an \( N \)-dimensional vector of observations, \( \boldsymbol{X}_m \) is an \( N \times K_m \) matrix of regressors, \( \boldsymbol{\beta}_m \) is a \( K_m \)-dimensional vector of location parameters, and \( \boldsymbol{\mu}_m \) is an \( N \)-dimensional vector of stochastic errors, for \( m = 1, 2, \dots, M \).

Let \( \boldsymbol{\mu}_i = \left[\mu_{i1} \ \mu_{i2} \ \dots \ \mu_{iM}\right]^{\top} \), where \( \boldsymbol{\mu}_i \sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{\Sigma}) \). Stacking the \( M \) equations, we can write the model as:

\[
\boldsymbol{y} = \boldsymbol{X} \boldsymbol{\beta} + \boldsymbol{\mu},
\]

where \( \boldsymbol{y} = \left[\boldsymbol{y}_1^{\top} \ \boldsymbol{y}_2^{\top} \ \dots \ \boldsymbol{y}_M^{\top}\right]^{\top} \) is an \( MN \)-dimensional vector, \( \boldsymbol{\beta} = \left[\boldsymbol{\beta}_1^{\top} \ \boldsymbol{\beta}_2^{\top} \ \dots \ \boldsymbol{\beta}_M^{\top}\right]^{\top} \) is a \( K \)-dimensional vector with \( K = \sum_{m=1}^M K_m \), and \( \boldsymbol{X} \) is an \( MN \times K \) block-diagonal matrix composed of the individual \( \boldsymbol{X}_m \), i.e.,

\[
\boldsymbol{X} = \begin{bmatrix}
    \boldsymbol{X}_1 & \boldsymbol{0} & \dots & \boldsymbol{0} \\
    \boldsymbol{0} & \boldsymbol{X}_2 & \dots & \boldsymbol{0} \\
    \vdots & \vdots & \ddots & \vdots \\
    \boldsymbol{0} & \boldsymbol{0} & \dots & \boldsymbol{X}_M
\end{bmatrix}.
\]

Similarly, the vector of errors is given by \( \boldsymbol{\mu} = \left[\boldsymbol{\mu}_1^{\top} \ \boldsymbol{\mu}_2^{\top} \ \dots \ \boldsymbol{\mu}_M^{\top}\right]^{\top} \), which is an \( MN \)-dimensional vector of stochastic errors, with \( \boldsymbol{\mu} \sim \mathcal{N}(\boldsymbol{0}, \boldsymbol{\Sigma} \otimes \boldsymbol{I}_N) \).

The likelihood function for the parameters is then:

\[
p(\boldsymbol{\beta}, \boldsymbol{\Sigma} \mid \boldsymbol{y}, \boldsymbol{X}) \propto |\boldsymbol{\Sigma}|^{-N/2} \exp\left\{ -\frac{1}{2} (\boldsymbol{y} - \boldsymbol{X} \boldsymbol{\beta})^{\top} (\boldsymbol{\Sigma}^{-1} \otimes \boldsymbol{I}_N) (\boldsymbol{y} - \boldsymbol{X} \boldsymbol{\beta}) \right\}.
\]

Using independent priors \( \pi(\boldsymbol{\beta}) \sim \mathcal{N}(\boldsymbol{\beta}_0, \boldsymbol{B}_0) \) and \( \pi(\boldsymbol{\Sigma}^{-1}) \sim W(\alpha_0, \boldsymbol{\Psi}_0) \), the posterior distributions are

\[
\boldsymbol{\beta} \mid \boldsymbol{\Sigma}, \boldsymbol{y}, \boldsymbol{X} \sim \mathcal{N}(\boldsymbol{\beta}_n, \boldsymbol{B}_n),
\]

\[
\boldsymbol{\Sigma}^{-1} \mid \boldsymbol{\beta}, \boldsymbol{y}, \boldsymbol{X} \sim W(\alpha_n, \boldsymbol{\Psi}_n),
\]

where \( \boldsymbol{B}_n = (\boldsymbol{X}^{\top} (\boldsymbol{\Sigma}^{-1} \otimes \boldsymbol{I}_N) \boldsymbol{X} + \boldsymbol{B}_0^{-1})^{-1} \), \( \boldsymbol{\beta}_n = \boldsymbol{B}_n (\boldsymbol{B}_0^{-1} \boldsymbol{\beta}_0 + \boldsymbol{X}^{\top} (\boldsymbol{\Sigma}^{-1} \otimes \boldsymbol{I}_N) \boldsymbol{y}) \), \( \alpha_n = \alpha_0 + N \) and \( \boldsymbol{\Psi}_n = (\boldsymbol{\Psi}_0^{-1} + \boldsymbol{U}^{\top} \boldsymbol{U})^{-1} \), where \( \boldsymbol{U} \) is an \( N \times M \) matrix whose columns are \( \boldsymbol{y}_m - \boldsymbol{X}_m \boldsymbol{\beta}_m \).

We can demonstrate, through straightforward yet tedious algebra, that by defining \( \boldsymbol{y}_i = [y_{i1} \ y_{i2} \ \dots \ y_{iM}] \) and

\[
\boldsymbol{X}_i = \begin{bmatrix}
    x_{1i}^{\top} & \boldsymbol{0} & \dots & \boldsymbol{0} \\
    \boldsymbol{0} & x_{2i}^{\top} & \dots & \boldsymbol{0} \\
    \vdots & \vdots & \ddots & \vdots \\
    \boldsymbol{0} & \boldsymbol{0} & \dots & x_{Mi}^{\top}
\end{bmatrix},
\]

we alternatively have \( \boldsymbol{B}_n = (\boldsymbol{B}_0^{-1} + \sum_{i=1}^N \boldsymbol{X}_i^{\top} \boldsymbol{\Sigma}^{-1} \boldsymbol{X}_i)^{-1} \), \( \boldsymbol{\beta}_n = \boldsymbol{B}_n (\boldsymbol{B}_0^{-1} \boldsymbol{\beta}_0 + \sum_{i=1}^N \boldsymbol{X}_i^{\top} \boldsymbol{\Sigma}^{-1} \boldsymbol{y}_i) \) and \( \boldsymbol{\Psi}_n = (\boldsymbol{\Psi}_0^{-1} + \sum_{i=1}^N (\boldsymbol{y}_i - \boldsymbol{X}_i^{\top} \boldsymbol{\beta}) (\boldsymbol{y}_i - \boldsymbol{X}_i^{\top} \boldsymbol{\beta})^{\top})^{-1} \).

Observe that we have standard conditional posteriors, thus, we can employ a Gibbs sampling algorithm to get the posterior draws.

**Example: Utility demand**

Let's use the dataset *Utilities.csv* to estimate a seemingly unrelated regression (SUR) model for utilities. We adopt the same setting as in Exercise 14 of Chapter \@ref(Chap3), where we estimate a multivariate regression model while omitting households with no consumption in any utility. In this exercise, we observe that not all regressors are relevant for the demand of electricity, water, and gas. Thus, we estimate the following model:

\begin{align*}
	\log(\text{electricity}_i) & = \beta_1 + \beta_2\log(\text{electricity price}_i) + \beta_3\log(\text{water price}_i) \\
	& + \beta_4\log(\text{gas price}_i) + \beta_5\text{IndSocio1}_i + \beta_6\text{IndSocio2}_i + \beta_7\text{Altitude}_i \\
	& + \beta_8\text{Nrooms}_i + \beta_9\text{HouseholdMem}_i + \beta_{10}\log(\text{Income}_i) + \mu_{i1} \\
	\log(\text{water}_i) & = \alpha_1 + \alpha_2\log(\text{electricity price}_i) + \alpha_3\log(\text{water price}_i) \\
	& + \alpha_4\log(\text{gas price}_i) + \alpha_5\text{IndSocio1}_i + \alpha_6\text{IndSocio2}_i \\
	& + \alpha_7\text{Nrooms}_i + \alpha_8\text{HouseholdMem}_i + \mu_{i2} \\
	\log(\text{gas}_i) & = \gamma_1 + \gamma_2\log(\text{electricity price}_i) + \gamma_3\log(\text{water price}_i) \\
	& + \gamma_4\log(\text{gas price}_i) + \gamma_5\text{IndSocio1}_i + \gamma_6\text{IndSocio2}_i + \gamma_7\text{Altitude}_i \\
	& + \gamma_8\text{Nrooms}_i + \gamma_9\text{HouseholdMem}_i + \mu_{i3},
\end{align*}

where electricity, water, and gas represent the monthly consumption of electricity (kWh), water (m$^3$), and gas (m$^3$) of Colombian households. The dataset includes information on 2,103 households, with details on the average prices of electricity (USD/kWh), water (USD/m$^3$), and gas (USD/m$^3$), as well as indicators of the socioeconomic conditions of the neighborhood where the household is located (IndSocio1 being the lowest and IndSocio3 the highest). Additionally, there is information on whether the household is located in a municipality situated at over 1,000 meters above sea level, the number of rooms in the house, the number of household members, and monthly income (USD).

Since each equation has a different set of regressors, and we suspect correlation between the stochastic errors of the three equations, we should estimate a seemingly unrelated regression (SUR) model. We expect unobserved correlation across these equations because we are modeling utilities, and in some cases, a single provider handles all three services and issues one bill.

The following Algorithm demonstrates how to estimate SUR models using our GUI. Our GUI utilizes the command *rsurGibbs* from the *bayesm* package in **R** software. See Chapter \@ref(Chap5) for further details, including instructions on how to set up the dataset, and check the templates available in our GitHub repository (**https://github.com/besmarter/BSTApp**) in the **DataApp** and **DataSim** folders.


::: {.algorithm}
<div style="background-color: #f8f9fa; padding: 15px; border-left: 5px solid #343a40; box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1); border-radius: 5px;">

**Algorithm: Seemingly Unrelated Regression (SUR)**  

1. Select *Multivariate Models* on the top panel 

2. Select *Seemingly Unrelated Regression* model using the left radio button 

3. Upload the dataset, selecting first if there is a header in the file, and the kind of separator in the *csv* file of the dataset (comma, semicolon, or tab). Then, use the *Browse* button under the **Choose File** legend 

4. Select MCMC iterations, burn-in, and thinning parameters using the *Range sliders*

5. Select the number of dependent variables in the box **Number of endogenous variables: m**  

6. Select the number of independent variables in the box **TOTAL number of Exogenous Variables: k**. This is the sum of all exogenous variables over all equations, including intercepts. In the example of **Utility demand**, it is equal to 27

7. Set the hyperparameters: mean vectors, covariance matrix, degrees of freedom, and the scale matrix. This step is not necessary as by default our GUI uses non-informative priors

8. Click the *Go!* button

9. Analyze results 

10. Download posterior chains and diagnostic plots using the *Download Posterior Chains* and *Download Posterior Graphs* buttons  

</div>
:::

The following code shows how to program this application using this package. We use 10,000 MCMC iterations, \( \boldsymbol{\beta}_0 = \boldsymbol{0}_{27} \), \( \boldsymbol{B}_0 = 100\boldsymbol{I}_{27} \), \( \alpha_0 = 5 \) and \( \boldsymbol{\Psi} = 5\boldsymbol{I}_3 \).

We find that the posterior median estimates of the own-price elasticities of demand for electricity, water, and gas are -1.88, -0.36, and -0.62, respectively, and none of the 95% credible intervals encompass 0. This means that a 1% increase in the prices of electricity, water, and gas results in a 1.88%, 0.36%, and 0.62% decrease in the monthly consumption of these utilities, respectively.^[This is an example where concerns about *biased* and *inconsistent* posterior mean estimates may arise, for instance, due to *reverse causality* between quantity and demand. These concerns are valid; however, we are using micro-level data, which implies no demand-supply simultaneity. Additionally, the utility providers operate in regulated natural monopoly markets, which mitigates endogeneity from searching provider strategies. Finally, we took prices directly from provider records, which avoids potential price measurement errors @ramirez2024welfare.] In general, there is evidence supporting the relevance of all regressors in these equations, with a few exceptions, and unobserved correlation in the demand for these services, which further supports the use of a SUR model in this application.


```{r}
rm(list = ls())
set.seed(010101)
library(dplyr)
DataUt <- read.csv("https://raw.githubusercontent.com/besmarter/BSTApp/refs/heads/master/DataApp/Utilities.csv", sep = ",", header = TRUE, quote = "")
DataUtEst <- DataUt %>%  
filter(Electricity != 0 & Water !=0 & Gas != 0)
attach(DataUtEst)
y1 <- log(Electricity); y2 <- log(Water); y3 <- log(Gas)
X1 <- cbind(1, LnPriceElect, LnPriceWater, LnPriceGas, IndSocio1, IndSocio2, Altitude, Nrooms, HouseholdMem, Lnincome)
X2 <- cbind(1, LnPriceElect, LnPriceWater, LnPriceGas, IndSocio1, IndSocio2, Nrooms, HouseholdMem)
X3 <- cbind(1, LnPriceElect, LnPriceWater, LnPriceGas, IndSocio1, IndSocio2, Altitude, Nrooms, HouseholdMem)
regdata <- NULL
regdata[[1]] <- list(y = y1, X = X1); regdata[[2]] <- list(y = y2, X = X2); regdata[[3]] <- list(y = y3, X = X3)
M <- length(regdata); K1 <- dim(X1)[2]; K2 <- dim(X2)[2]; K3 <- dim(X3)[2] 
K <- K1 + K2 + K3
# Hyperparameters
b0 <- rep(0, K); c0 <- 100; B0 <- c0*diag(K); V <- 5*diag(M); a0 <- M
Prior <- list(betabar = b0, A = solve(B0), nu = a0, V = V)
#Posterior draws
S <- 10000; keep <- 1; Mcmc <- list(R = S, keep = keep, nprint = 0)
PosteriorDraws <- bayesm::rsurGibbs(Data = list(regdata = regdata), Mcmc = Mcmc, Prior = Prior)
Bs <- PosteriorDraws[["betadraw"]]
Names <- c("Const", "LnPriceElect", "LnPriceWater", "LnPriceGas", "IndSocio1", "IndSocio2", 
"Altitude", "Nrooms", "HouseholdMem", "Lnincome", "Const",
"LnPriceElect", "LnPriceWater", "LnPriceGas", "IndSocio1", "IndSocio2", 
"Nrooms", "HouseholdMem","Const",
"LnPriceElect", "LnPriceWater", "LnPriceGas", "IndSocio1", "IndSocio2", 
"Altitude", "Nrooms", "HouseholdMem")
colnames(Bs) <- Names
summary(coda::mcmc(Bs))
summary(PosteriorDraws[["Sigmadraw"]])
```

We ask in the Exercise 5 to run this application using our GUI and the information in the dataset *Utilities.csv*. Observe that this file should be modified to agree the structure that requires our GUI (see the dataset *5Institutions.csv* in the folder *DataApp* of our GitHub repository -**https://github.com/besmarter/BSTApp**- for a template). In addition, we ask to program from scratch the Gibbs sampler algorithm in this application.

## Instrumental variable {#sec73}

This inferential approach is used when there are *endogeneity* issues, that is, when the stochastic error is not independent of the regressors. This, in turn, generates *bias* in posterior mean estimates when we use an inferential approach that does not account for this issue. *Endogeneity* can be caused by *reverse causality*, *omitting relevant correlated variables*, or *measurement error* in the regressors.^[See @wooldridge2016introductory, Chap. 15 for an introductory treatment of instrumental variables in the Frequentist inferential approach.]

Let’s specify the dependent variable as a linear function of one endogenous regressor and some exogenous regressors. That is,  

\[
y_{i} = \boldsymbol{x}_{ei}^{\top} \boldsymbol{\beta}_1 + \beta_s x_{si} + \mu_{i}
\]

where  

\[
x_{si} = \boldsymbol{x}_{ei}^{\top} \boldsymbol{\gamma}_1 + \boldsymbol{z}_i^{\top} \boldsymbol{\gamma}_2 + v_{i},
\]

\( x_s \) is the variable that generates the endogeneity issues (\(\mathbb{E}[\mu \mid x_{s}] \neq 0\)), \( \boldsymbol{x}_e \) are \( K_1 \) exogenous regressors (\(\mathbb{E}[\mu \mid \boldsymbol{x}_{e}] = \boldsymbol{0}\)), and \( \boldsymbol{z} \) are \( K_2 \) instruments. The instruments are regressors that drive \( x_s \) (\(\mathbb{E}[x_{s} \boldsymbol{z}] \neq \boldsymbol{0}\)), but do not have a direct effect on \( y \) (\(\mathbb{E}[y \boldsymbol{z} \mid x_s] = \boldsymbol{0}\)). The equation for \( y \) is called the *structural equation*, and it is the equation that the researcher is ultimately interested in.

Assuming  

\[
(u_{i},v_i)^{\top} \stackrel{i.i.d.}{\thicksim} N(0,\boldsymbol{\Sigma}),
\]

where \( \boldsymbol{\Sigma}=[\sigma_{lm}] \), \( l,m=1,2 \), the likelihood function is  

\[
p(\boldsymbol{\beta},\boldsymbol{\gamma},\boldsymbol{\Sigma} \mid \boldsymbol{y},\boldsymbol{X},\boldsymbol{Z}) = \frac{1}{(2\pi)^\frac{N}{2}|\boldsymbol{\Sigma}|^\frac{N}{2}} \exp\left\{-\frac{1}{2} \sum_{i=1}^N (y_i-\boldsymbol{x}_i^{\top} \boldsymbol{\beta}, x_{si} -\boldsymbol{w}_i^{\top} \boldsymbol{\gamma}) \boldsymbol{\Sigma}^{-1}
\begin{pmatrix}
y_i - \boldsymbol{x}_i^{\top} \boldsymbol{\beta} \\
x_{si} - \boldsymbol{w}_i^{\top} \boldsymbol{\gamma}
\end{pmatrix}
\right\},
\]

where  

\[
\boldsymbol{\beta}=\begin{bmatrix} \boldsymbol{\beta}_1^{\top} & \beta_s \end{bmatrix}^{\top}, \quad 
\boldsymbol{\gamma}=\begin{bmatrix} \boldsymbol{\gamma}_1^{\top} & \boldsymbol{\gamma}_2^{\top} \end{bmatrix}^{\top}, \quad
\boldsymbol{x}_i=\begin{bmatrix} \boldsymbol{x}_{ei}^{\top} & x_{si} \end{bmatrix}^{\top}, \quad 
\boldsymbol{w}_i=\begin{bmatrix} \boldsymbol{x}_{ei}^{\top} & \boldsymbol{z}_{i}^{\top} \end{bmatrix}^{\top}.
\]

We obtain the standard conditional posterior densities by specifying the following independent priors:  

\[
\boldsymbol{\gamma} \sim N(\boldsymbol{\gamma}_0, \boldsymbol{G}_0), \quad 
\boldsymbol{\beta} \sim N(\boldsymbol{\beta}_0, \boldsymbol{B}_0), \quad 
\boldsymbol{\Sigma}^{-1} \sim W(\alpha_0, \boldsymbol{\Psi}_0).
\]

In particular, the conditional distributions are:  

\[
\boldsymbol{\beta} \mid \boldsymbol{\gamma}, \boldsymbol{\Sigma}, \boldsymbol{y}, \boldsymbol{X}, \boldsymbol{Z} \sim N(\boldsymbol{\beta}_n, \boldsymbol{B}_n),
\]

\[
\boldsymbol{\gamma} \mid \boldsymbol{\beta}, \boldsymbol{\Sigma}, \boldsymbol{y}, \boldsymbol{X}, \boldsymbol{Z} \sim N(\boldsymbol{\gamma}_n, \boldsymbol{G}_n),
\]

\[
\boldsymbol{\Sigma}^{-1} \mid \boldsymbol{\beta}, \boldsymbol{\gamma}, \boldsymbol{y}, \boldsymbol{X}, \boldsymbol{Z} \sim W(\alpha_n, \boldsymbol{\Psi}_n),
\]

where  

\[
\boldsymbol{\beta}_n = \boldsymbol{B}_n \left( \boldsymbol{B}_0^{-1} \boldsymbol{\beta}_0 + \omega_1^{-1} \sum_{i=1}^{N} \left[ \boldsymbol{x}_i \left( y_i - \frac{\sigma_{12}(x_{si} - \boldsymbol{w}_i^{\top} \boldsymbol{\gamma})}{\sigma_{22}} \right) \right] \right),
\]

\[
\boldsymbol{B}_n = \left( \omega_1^{-1} \sum_{i=1}^{N} \boldsymbol{x}_i \boldsymbol{x}_i^{\top} + \boldsymbol{B}_0^{-1} \right)^{-1}, \quad 
\omega_1 = \sigma_{11} - \frac{\sigma_{12}^2}{\sigma_{22}},
\]

\[
\boldsymbol{G}_n = \left( \omega_2^{-1} \sum_{i=1}^{N} \boldsymbol{w}_i \boldsymbol{w}_i^{\top} + \boldsymbol{G}_0^{-1} \right)^{-1}, \quad 
\boldsymbol{\gamma}_n = \boldsymbol{G}_n \left( \boldsymbol{G}_0^{-1} \boldsymbol{\gamma}_0 + \omega_2^{-1} \sum_{i=1}^{N} \left[ \boldsymbol{w}_i \left( x_{si} - \frac{\sigma_{12} (y_i - \boldsymbol{x}_i^{\top} \boldsymbol{\beta})}{\sigma_{11}} \right) \right] \right),
\]

\[
\omega_2 = \sigma_{22} - \frac{\sigma_{12}^2}{\sigma_{11}}, \quad 
\boldsymbol{\Psi}_n = \left[ \boldsymbol{\Psi}_0^{-1} + \sum_{i=1}^N 
\begin{pmatrix} y_i - \boldsymbol{x}_i^{\top} \boldsymbol{\beta} \\ x_{si} - \boldsymbol{w}_i^{\top} \boldsymbol{\gamma} \end{pmatrix}  
(y_i - \boldsymbol{x}_i^{\top} \boldsymbol{\beta}, x_{si} - \boldsymbol{w}_i^{\top} \boldsymbol{\gamma}) 
\right]^{-1},
\]

\[
\alpha_n = \alpha_0 + N, \quad \sigma_{lj} \text{ are the elements of } \boldsymbol{\Sigma}.
\]

We also use a Gibbs sampling algorithm in this model since we have standard conditional posterior distributions.

**Example: Simulation exercise**

Let's simulate the simple process \( y_i=\beta_1+\beta_2x_{si}+\mu_i \) and \( x_{si}=\gamma_1+\gamma_2z_i+v_i \) where \( [\mu_i \ v_i]^{\top} \sim N(\boldsymbol{0},\boldsymbol{\Sigma}) \), \( \boldsymbol{\Sigma}=[\sigma_{lj}] \) such that \( \sigma_{12} \neq 0 \), \( i=1,2,\dots,100 \).

Observe that \( \mu\mid v\sim N\left(\frac{\sigma_{12}}{\sigma_{22}}v,\sigma_{11}-\frac{\sigma_{21}^2}{\sigma_{22}}\right) \), this implies that \( \mathbb{E}[\mu\mid x_s]=\mathbb{E}[\mu\mid v]=\frac{\sigma_{12}}{\sigma_{22}}v\neq 0 \) given \( \sigma_{12}\neq 0 \) and \( \mathbb{E}[\mu\mid z]=0 \).
Let's set all location parameters equal to 1, and \( \sigma_{11}=\sigma_{22}=1 \), \( \sigma_{12}=0.8 \), and \( z\sim N(0,1) \). 

We know from the large sampling properties of the posterior mean that this converges to the maximum likelihood estimator (see Section \@ref(sec11), and @Lehmann2003, @van2000asymptotic), which in this setting is 

\[
\hat{\beta}_2=\frac{\widehat{\text{Cov}}(x_s,y)}{\widehat{\text{Var}}(x_s)}
\]

which converges in probability to 

\[
\beta_2+\frac{\sigma_{12}}{\sigma_{22}\text{Var}(x_s)}=\beta_2+\frac{\sigma_{12}}{\sigma_{22}(\gamma_2^2\text{Var}(z)+\sigma_{22})}=1.4,
\]

that is, the asymptotic bias when using the posterior mean of a linear regression without taking into account endogeneity is 0.4 in this example.

We assess the sampling performance of the Bayesian estimators by simulating this setting 100 times. The following code demonstrates how to do this using a linear model that does not account for the *endogeneity* issue (see Section \@ref(sec61)), as well as how to implement the instrumental variable model. In this setup, we use \( \boldsymbol{B}_0 = 1000 \mathbf{I}_2 \), \( \boldsymbol{\beta}_0 = \mathbf{0}_2 \), and the parameters of the inverse gamma distribution are set to 0.0005. For the instrumental variable model, we additionally set \( \boldsymbol{\gamma}_0 = \mathbf{0}_2 \), \( \boldsymbol{G}_0 = 1000 \mathbf{I}_2 \), \( \alpha_0 = 3 \), and \( \boldsymbol{\Psi}_0 = 3 \mathbf{I}_2 \).


```{r}
rm(list = ls()); set.seed(010101)
N <- 100; k <- 2
B <- rep(1, k); G <- rep(1, 2); s12 <- 0.8
SIGMA <- matrix(c(1, s12, s12, 1), 2, 2)
z <- rnorm(N); Z <- cbind(1, z); w <- matrix(1,N,1); S <- 100
U <- replicate(S, MASS::mvrnorm(n = N, mu = rep(0, 2), SIGMA))
x <- G[1] + G[2]*z + U[,2,]; y <- B[1] + B[2]*x + U[,1,]
# Hyperparameters
d0 <- 0.001/2; a0 <- 0.001/2
b0 <- rep(0, k); c0 <- 1000; B0 <- c0*diag(k)
B0i <- solve(B0); g0 <- rep(0, 2)
G0 <- 1000*diag(2); G0i <- solve(G0)
nu <- 3; Psi0 <- nu*diag(2)
# MCMC parameters
mcmc <- 5000; burnin <- 1000
tot <- mcmc + burnin; thin <- 1
# Gibbs sampling
Gibbs <- function(x, y){
	Data <- list(y = y, x = x, w = w, z = Z)
	Mcmc <- list(R = mcmc, keep = thin, nprint = 0)
	Prior <- list(md = g0, Ad = G0i, mbg = b0, Abg = B0i, nu = nu, V = Psi0)
	RestIV <- bayesm::rivGibbs(Data = Data, Mcmc = Mcmc, Prior = Prior)
	PostBIV <- mean(RestIV[["betadraw"]])
	ResLM <- MCMCpack::MCMCregress(y ~ x + w - 1, b0 = b0, B0 = B0i, c0 = a0, d0 = d0)
	PostB <- mean(ResLM[,1]); Res <- c(PostB,PostBIV)
	return(Res)
}
PosteriorMeans <- sapply(1:S, function(s) {Gibbs(x = x[,s], y = y[,s])})
rowMeans(PosteriorMeans)
Model <- c(replicate(S, "Ordinary"), replicate(S, "Instrumental"))
postmeans <- c(t(PosteriorMeans))
df <- data.frame(postmeans, Model, stringsAsFactors = FALSE)
library(ggplot2); library(latex2exp)
histExo <- ggplot(df, aes(x = postmeans, fill = Model)) + geom_histogram(bins = 40, position = "identity", color = "black", alpha = 0.5) + labs(title = "Overlayed Histograms", x = "Value", y = "Count") + scale_fill_manual(values = c("blue", "red")) + geom_vline(aes(xintercept = mean(postmeans[1:S])), color = "black", linewidth = 1, linetype = "dashed") + geom_vline(aes(xintercept = mean(postmeans[101:200])), color = "black", linewidth = 1, linetype = "dashed") + geom_vline(aes(xintercept = B[2]), color = "green", linewidth = 1, linetype = "dashed") + xlab(TeX("$E[\\beta_2]$")) + ylab("Frequency") + ggtitle("Histogram: Posterior means simulating 100 samples") 
histExo 
```

The Figure displays the histograms of the posterior means of \( \beta_2 \) using the ordinary model, which does not account for endogeneity, and the instrumental variable model. On one hand, the mean of the posterior means for the ordinary model is 1.41 (black dashed line in the red histogram), implying a bias of 0.41, which is very close to the population bias of 0.40. On the other hand, the mean of the posterior means for the instrumental variable model is 1.04 (black dashed line in the blue histogram), which is close to the population value of \( \beta_2 = 1 \) (green dashed line).

We also observe that the histogram of the posterior means for the ordinary model is less dispersed. That is, this estimator is more efficient, which is a well-known result in the Frequentist inferential approach when comparing ordinary least squares and two-stage least squares (see @wooldridge2010econometric).

Two very important aspects in the instrumental variables literature are the *weakness* and *exogeneity* of the instruments. The former refers to how strong the relationship is between the instruments and the endogenous regressors, while the latter refers to the independence of the instruments from the stochastic error in the *structural equation*. In Exercise 6, we ask you to use the previous code as a baseline to study these two aspects. Observe the link between the *weakness* and *exogeneity* of the instrument, and the *exclusion restrictions* (\( \mathbb{E}[x_s \boldsymbol{z}] \neq \boldsymbol{0} \) and \( \mathbb{E}[y \boldsymbol{z} \mid x_s] = \boldsymbol{0} \)). This is the point of departure of @Conley2012, who propose assessing the plausibility of the *exclusion restrictions* by defining *plausible exogeneity* as having prior information that the effect of the instrument in the *structural equation* is near zero, but perhaps not exactly zero.

The following Algorithm can be used to estimate the instrumental variable model using our GUI. We ask in Exercise 8 to replicate the example of the effect of institutions on per capita GDP using our GUI.  


::: {.algorithm}
<div style="background-color: #f8f9fa; padding: 15px; border-left: 5px solid #343a40; box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1); border-radius: 5px;">

**Algorithm: Instrumental Variable Model**  

1. Select *Multivariate Models* on the top panel  

2. Select *Variable instrumental (two equations)* model using the left radio button

3. Upload the dataset, selecting first if there is a header in the file, and the kind of separator in the *csv* file of the dataset (comma, semicolon, or tab). Then, use the *Browse* button under the **Choose File** legend 

4. Select MCMC iterations, burn-in, and thinning parameters using the *Range sliders* 

5. Write down the formula of the structural equation in the **Main Equation** box. This formula must be written using the syntax of the *formula* command of **R** software. This equation includes the intercept by default, do not include it in the equation

6. Write down the formula of the endogenous regressor in the **Instrumental Equation** box. This formula must be written using the syntax of the *formula* command of **R** software. This equation includes the intercept by default, do not include it in the equation

7. Set the hyperparameters: mean vectors, covariance matrices, degrees of freedom, and the scale matrix. This step is not necessary as by default our GUI uses non-informative priors

8. Click the *Go!* button 

9. Analyze results

10. Download posterior chains and diagnostic plots using the *Download Posterior Chains* and *Download Posterior Graphs* buttons  

</div>
:::

## Multivariate probit model {#sec74}

In the multivariate probit model @Edwards2003, the response variable \( y_{il} = \{0, 1\} \) indicates that individual \( i \) makes binary choices among \( L \) mutually exclusive alternatives, where \( l = 1, 2, \dots, L \) and \( i = 1, 2, \dots, N \). Specifically,

\[
	y_{il} =
	\begin{cases}
		0, & \quad y_{il}^* \leq 0 \\
		1, & \quad y_{il}^* > 0
	\end{cases}
\]

where \( \boldsymbol{y}_i^* = \boldsymbol{X}_i \boldsymbol{\beta} + \boldsymbol{\mu}_i \sim \text{i.i.d.} \, N(\boldsymbol{0}, \boldsymbol{\Sigma}) \). Here, \( \boldsymbol{y}_i^* \) is an unobserved latent \( L \)-dimensional vector, \( \boldsymbol{X}_i = \boldsymbol{x}_i^\top \otimes \mathbf{I}_L \) is an \( L \times K \) design matrix of regressors, with \( K = L \times k \), where \( k \) is the number of regressors (i.e., the length of \( \boldsymbol{x}_i \)). In addition, \( \boldsymbol{\beta} = \left[\boldsymbol{\beta}_1^\top \ \boldsymbol{\beta}_2^\top \dots \boldsymbol{\beta}_k^\top\right]^\top \), where \( \boldsymbol{\beta}_j \) forms an \( L \)-dimensional vector of coefficients for \( j = 1, 2, \dots, k \).

The likelihood function for this model is given by

\[
p(\boldsymbol{\beta}, \boldsymbol{\Sigma} \mid \boldsymbol{y}, \boldsymbol{X}) = \prod_{i=1}^N \prod_{l=1}^L p_{il}^{y_{il}},
\]

where \( p_{il} = p(y_{il}^* \geq 0) \).

Observe that \( p({y}_{il}^*\geq 0)=p({\lambda}_{ll}{y}_{il}^*\geq 0) \), \( \lambda_{ll}>0 \). This generates identification issues because only the correlation matrix can be identified, similar to the univariate probit model where the variance of the model is fixed to 1. We follow the post-processing strategy proposed by @Edwards2003 to obtain identified parameters, that is, \( \tilde{\boldsymbol{\beta}}=\text{vec}\left\{\boldsymbol{\Lambda}\mathbf{B}\right\} \) and the correlation matrix \( \boldsymbol{R}=\boldsymbol{\Lambda}\boldsymbol{\Sigma}\boldsymbol{\Lambda} \), where \( \boldsymbol{\Lambda}=\text{diag}\left\{\sigma_{ll}\right\}^{-1/2} \) and \( \mathbf{B}=\left[\boldsymbol{\beta}_1 \ \boldsymbol{\beta}_2 \dots \boldsymbol{\beta}_k\right] \).^[In a Bayesian setting, a model can be non-identified; however, the posterior distribution of the model parameters exists as long as a proper prior distribution is specified @Edwards2003.]

We assume independent priors: \( \boldsymbol{\beta} \sim N(\boldsymbol{\beta}_0, \boldsymbol{B}_0) \) and \( \boldsymbol{\Sigma}^{-1} \sim W(\alpha_0, \boldsymbol{\Psi}_0) \). We can apply Gibbs sampling to this model, as it is a standard Bayesian linear regression model when data augmentation in \( \boldsymbol{y}^* \) is used.

The posterior conditional distributions are
\begin{equation}
	\boldsymbol{\beta}\mid \boldsymbol{\Sigma},\boldsymbol{w} \sim N(\boldsymbol{\beta}_n,\boldsymbol{B}_n),
\end{equation}
\begin{equation}
	\boldsymbol{\Sigma}^{-1} \mid \boldsymbol{\beta},\boldsymbol{w} \sim W(\alpha_n,\boldsymbol{\Psi}_n),
\end{equation}
\begin{equation}
	y_{il}^* \mid \boldsymbol{y}_{i,-l}^*,\boldsymbol{\beta},\boldsymbol{\Sigma}^{-1},\boldsymbol{y_i} \sim TN_{I_{il}}(m_{il},\tau_{ll}^2)
\end{equation}

where \( \boldsymbol{B}_n=(\boldsymbol{B}_0^{-1}+\boldsymbol{X}^{*\top}\boldsymbol{X}^*)^{-1} \), \( \boldsymbol{\beta}_n=\boldsymbol{B}_n(\boldsymbol{B}_0^{-1}\boldsymbol{\beta}_0+\boldsymbol{X}^{*\top}\boldsymbol{y}^{**}) \), \( \boldsymbol{\Sigma}^{-1}=\boldsymbol{C}^{\top}\boldsymbol{C} \), \( \boldsymbol{X}_i^{*}=\boldsymbol{C}^{\top}\boldsymbol{X}_i \), \( \boldsymbol{y}_i^{**}=\boldsymbol{C}^{\top}\boldsymbol{y}_i^* \), \( \alpha_n=\alpha_0+N \), \( \boldsymbol{\Psi}_n=(\boldsymbol{\Psi}_0+\sum_{i=1}^N (\boldsymbol{y}_i^*-\boldsymbol{X}_i\boldsymbol{\beta})(\boldsymbol{y}_i^*-\boldsymbol{X}_i\boldsymbol{\beta})^{\top})^{-1} \),  

\[
m_{il}=\boldsymbol{x}_{il}^{\top}\boldsymbol{\beta}+\boldsymbol{f}_l^{\top}(\boldsymbol{y}_{i,-l}^*-\boldsymbol{X}_{i,-l}\boldsymbol{\beta}),
\]

where \( \boldsymbol{y}_{i,-l}^* \) is an \( L-1 \) dimensional vector of all components of \( \boldsymbol{y}_i^* \) excluding \( y_{il}^* \), \( \boldsymbol{x}_{il}^{\top} \) is the \( l \)-th row of \( \boldsymbol{X}_i \), \( \boldsymbol{X}_{i,-l} \) is \( \boldsymbol{X}_{i} \) after deleting the \( l \)-th row,  

\[
\boldsymbol{f}_l^{\top}=\boldsymbol{\omega}_{l,-l}^{\top}\boldsymbol{\Sigma}_{-l,-l}^{-1},
\]

where \( \boldsymbol{\omega}_{l,-l}^{\top} \) and \( \boldsymbol{\Sigma}_{-l,-l} \) are the \( l \)-th row of \( \boldsymbol{\Sigma} \) extracting the \( l \)-th element, and the sub-matrix of \( \boldsymbol{\Sigma} \) extracting the \( l,l \) element, and  

\[
\tau_{ll}^2=\sigma_{l,l}-\boldsymbol{\omega}_{l,-l}^{\top}\boldsymbol{\Sigma}_{-l,-l}^{-1}\boldsymbol{\omega}_{-l,l},
\]

and

\[
\boldsymbol{X}^*=
\begin{bmatrix}
	\boldsymbol{X}_1^*\\
	\boldsymbol{X}_2^*\\
	\vdots\\
	\boldsymbol{X}_N^*
\end{bmatrix}, 
\quad 
I_{il}=
\begin{Bmatrix} 
	y_{il}^*> 0, & y_{il}=1\\
	y_{il}^*\leq 0 , & y_{il}=0
\end{Bmatrix},
\quad 
\boldsymbol{\Sigma}=
\begin{bmatrix}
	\boldsymbol{\omega}_1^{\top} \\ 
	\boldsymbol{\omega}_2^{\top} \\ 
	\vdots \\ 
	\boldsymbol{\omega}_{L}^{\top} 
\end{bmatrix}.
\]

The setting in our GUI has the same regressors in each binary decision. However, we can see that the multivariate probit model is similar to a SUR model in latent variables. We ask in Exercise 9 to implement a Gibbs sampling algorithm for a multivariate probit model with different regressors in each equation.

**Example: Self selection in hospitalization due to a subsidized health care program**

We use the dataset *7HealthMed.csv*, where the dependent variable is $y = \left[\text{Hosp} \ \text{SHI}\right]^{\top}$, with $\text{Hosp} = 1$ if an individual was hospitalized in the year prior to the survey (0 otherwise), and $\text{SHI} = 1$ if the individual had subsidized health insurance (0 otherwise).

Recall that our application of binary response models aimed to uncover the determinants of hospitalization in Medellín (Colombia), where one of the regressors was a binary indicator of participation in a subsidized health care program (Section \@ref(sec63)). We can use a bivariate probit model if we suspect there is dependence between the decisions regarding these two variables. A priori, we would expect that being in a subsidized health care program increases the probability of hospitalization *ceteris paribus*, due to reduced costs for the patient. However, if an individual expects to be hospitalized in the future, and the factors influencing this decision are unobserved by the modeler, a feedback effect may exist from hospitalization to enrollment in the subsidized health care program.


We considered seven regressors: a constant, gender (female), age, self-perception of health status (with categories fair, good, and excellent, using bad as the reference category), and the proportion of the individual’s age spent living in their neighborhood. The last variable attempts to account for social capital, which can affect enrollment in the subsidized health insurance program, as the target population is identified by the local government [@Ramirez2019a]. The dataset includes 12,975 individuals who can "choose" two options: hospitalization and enrollment in the subsidized health insurance regime.

The following Algorithm shows how to run a multivariate probit model using our GUI.

::: {.algorithm}
<div style="background-color: #f8f9fa; padding: 15px; border-left: 5px solid #343a40; box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.1); border-radius: 5px;">

**Algorithm: Multivariate Probit Model**  

1. Select *Multivariate Models* on the top panel  

2. Select *Multivariate Probit* model using the left radio button 

3. Upload the dataset, selecting first if there is a header in the file, and the kind of separator in the *csv* file of the dataset (comma, semicolon, or tab). Then, use the *Browse* button under the **Choose File** legend  

4. Select MCMC iterations, burn-in, and thinning parameters using the *Range sliders* 

5. Write down the number of cross-sectional units in the **Number of individuals: n** box 

6. Write down the number of exogenous variables in the **Number of exogenous variables: k** box

7. Write down the number of choices in the **Number of choices: l** box

8. Set the hyperparameters: mean vectors, covariance matrix, degrees of freedom, and the scale matrix. This step is not necessary as by default our GUI uses non-informative priors

9. Click the *Go!* button

10. Analyze results 

11. Download posterior chains and diagnostic plots using the *Download Posterior Chains* and *Download Posterior Graphs* buttons  

</div>
:::

We set 20,000 MCMC iterations with a thinning parameter equal to 5. The hyperparameters are $\boldsymbol{\beta}_0 = \boldsymbol{0}_{14}$, $\boldsymbol{B}_0 = 100\boldsymbol{I}_{14}$, $\alpha_0 = 4$, and $\boldsymbol{\Psi}_0 = 4\boldsymbol{I}_2$.^[Note that the order of the location coefficients in our GUI follows the equations, not the order of the regressors as in the theoretical setting presented in this section. This distinction is important for correctly setting the hyperparameters and interpreting the results of the location parameters.]


```{r}
rm(list = ls()); set.seed(010101)
Data <- read.csv("https://raw.githubusercontent.com/besmarter/BSTApp/refs/heads/master/DataApp/7HealthMed.csv", sep = ",", header = TRUE, quote = "")
attach(Data); str(Data)
p <- 2; nd <- 7; N <- length(y)/p; y <- y
Xd <- as.matrix(Data[seq(1, p*N, 2),3:9])
XcreateMP<-function(p,nxs,nind,Data){
	pandterm = function(message) {
		stop(message, call. = FALSE)
	}
	if (missing(nxs)) 
	pandterm("requires number of regressors: include intercept if required")
	if (missing(nind)) 
	pandterm("requires number of units (individuals)")
	if (missing(Data)) 
	pandterm("requires dataset")
	if (nrow(Data)!=nind*2)
	pandterm("check dataset! number of units times number alternatives should be equal to dataset rows")
	XXDat<-array(0,c(p,1+nxs,nind))
	XX<-array(0,c(p,nxs*p,nind))
	YY<-array(0,c(p,1,nind))
	is<- seq(p,nind*p,p)
	cis<- seq(nxs,nxs*p+1,nxs)
	for(i in is){
		j<-which(i==is)
		XXDat[,,j]<-as.matrix(Data[c((i-(p-1)):i),-1])
		YY[,,j]<-XXDat[,1,j]
		for(l in 1:p){
			XX[l,((cis[l]-(nxs-1)):cis[l]),j]<-XXDat[l,-1,j]
		}
	}
	return(list(y=YY,X=XX))
}
Dat <- XcreateMP(p = p, nxs = nd, nind = N, Data = Data)
y<-NULL; X<-NULL
for(i in 1:dim(Dat$y)[3]){
	y<-c(y,Dat$y[,,i])
	X<-rbind(X,Dat$X[,,i])
}
DataMP = list(p=p, y=y, X=X)
# Hyperparameters
k <- dim(X)[2]; b0 <- rep(0, k); c0 <- 1000
B0 <- c0*diag(k); B0i <- solve(B0)
a0 <- p - 1 + 3; Psi0 <- a0*diag(p)
Prior <- list(betabar = b0, A = B0i, nu = a0, V = Psi0)
# MCMC parameters
mcmc <- 20000; thin <- 5; 
Mcmc <- list(R = mcmc, keep = thin, nprint = 0)
Results <- bayesm::rmvpGibbs(Data = DataMP, Mcmc = Mcmc, Prior = Prior)
betatilde1 <- Results$betadraw[,1:7] / sqrt(Results$sigmadraw[,1])
summary(coda::mcmc(betatilde1))
betatilde2 <- Results$betadraw[,8:14] / sqrt(Results$sigmadraw[,4])
summary(coda::mcmc(betatilde2))
sigmadraw12 <-  Results$sigmadraw[,3] / (Results$sigmadraw[,1]*Results$sigmadraw[,4])^0.5
summary(coda::mcmc(sigmadraw12))
```

The previous **R** code demonstrates how to obtain the posterior draws using the *rmvpGibbs* command from the *bayesm* package. The results suggest that females, older individuals, and those who self-assess their health as poor are more likely to be hospitalized. Furthermore, females, older individuals, and those with a poor or fair self-perception of health, who have lived a larger proportion of their life in their current neighborhood, are more likely to be enrolled in the subsidized health care system. However, the results indicate that there is no unobserved correlation between the two equations, as the 95% credible interval for the correlation is (-0.07, 0.06).

## Summary {#sec75}

In this chapter, we present the setting and posterior distributions of the most common multivariate models. The multivariate framework allows us to address *endogeneity* issues by using the conditional distribution of a multivariate normal vector. Moreover, we always obtain posterior conditional distributions that belong to standard families (multivariate normal, Wishart, and truncated normal) in these models. This property enables the implementation of the Gibbs sampling algorithm for all these models.

## Exercises {#sec76}

1. Show that $\mathbb{E}[u_1\text{PAER}] = \frac{\alpha_1}{1 - \beta_1\alpha_1} \sigma_1^2$, assuming that $\mathbb{E}[u_1 u_2] = 0$, where $\text{Var}(u_1) = \sigma_1^2$, in the example of the effect of institutions on per capita GDP.  

2. Show that $\beta_1=\pi_1/\gamma_1$, in the example of the effect of institutions on per capita GDP.  

3. **The effect of institutions on per capita gross domestic product continues I**  

   Use the *rmultireg* command from the *bayesm* package to perform inference in the example of the effect of institutions on per capita GDP.  

4. **Demand and supply simulation**  

   Given the structural demand-supply model:  
   $$
   \begin{aligned}
   q_i^d &= \beta_1 + \beta_2 p_i + \beta_3 y_i + \beta_4 pc_i + \beta_5 ps_i + u_{i1}, \\
   q_i^s &= \alpha_1 + \alpha_2 p_i + \alpha_3 er_i + u_{i2},
   \end{aligned}
   $$
   where $q^d$ is demand, $q^s$ is supply, $p$, $y$, $pc$, $ps$, and $er$ are price, income, complementary price, substitute price, and exchange rate, respectively. Complementary and substitute prices refer to the prices of complementary and substitute goods for $q$. Assume that  
   $$
   \boldsymbol{\beta} = \begin{bmatrix} 5 \\ -0.5 \\ 0.8 \\ -0.4 \\ 0.7 \end{bmatrix}, \quad 
   \boldsymbol{\alpha} = \begin{bmatrix} -2 \\ 0.5 \\ -0.4 \end{bmatrix},
   $$
   $u_1 \sim N(0, 0.5^2)$, and $u_2 \sim N(0, 0.5^2)$. Additionally, assume that $y \sim N(10, 1)$, $pc \sim N(5, 1)$, $ps \sim N(5, 1)$, and $er \sim N(15, 1)$.  

   - Find the *reduced-form* model by using the condition that in equilibrium, demand and supply are equal, i.e., $q^d = q^s$. This condition defines the observable quantity, $q$.  
   - Simulate $p$ and $q$ from the *reduced-form* equations.  
   - Perform inference for the *reduced-form* model using the *rmultireg* command from the *bayesm* package.  
   - Use the posterior draws of the *reduced-form* parameters to perform inference for the *structural* parameters. Any issues? Hint: Are all *structural* parameters exactly identified?  

5. **Utility demand continues**  

   - Run the **Utility demand** application using our GUI and the information in the dataset *Utilities.csv*. Hint: This file should be modified to agree with the structure that our GUI requires (see the dataset *5Institutions.csv* in the folder *DataApp* of our GitHub repository - **https://github.com/besmarter/BSTApp** - for a template).  
   - Program from scratch the Gibbs sampler algorithm in this application.  

6. **Simulation exercise of instrumental variables continues I**  

   - Use the setting of the simulation exercise with instrumental variables to analyze the impact of a weak instrument. For instance, set $\gamma_2 = 0.2$ and compare the performance of the posterior means of the ordinary and instrumental variable models.  
   - Perform a simulation to analyze how the degree of exogeneity of the instrument affects the performance of the posterior mean in the instrumental variable model.  

7. **Simulation exercise of instrumental variables continues II**  

   Program from scratch the Gibbs sampling algorithm of the instrumental model for the simulation exercise of the instrumental variables.  

8. **The effect of institutions on per capita gross domestic product continues II**  

   Estimate the structural Equation \@ref(eq:str1) using the instrumental variable model where the instrument of PAER is $\log(\textit{Mort})$. Compare the effect of property rights on per capita GDP of this model with the effect estimated in the example of the effect of institutions on per capita gross domestic product. Use the file *6Institutions.csv* to do this exercise in our GUI, and set  
   $$
   \boldsymbol{B}_0=100\boldsymbol{I}_5, \quad \boldsymbol{\beta}_0=\boldsymbol{0}_5, \quad \boldsymbol{\gamma}_0=\boldsymbol{0}_2, \quad \boldsymbol{G}_0=100\boldsymbol{I}_2, \quad \alpha_0=3, \quad \boldsymbol{\Psi}_0=3\boldsymbol{I}_2.
   $$
   The MCMC iterations, burn-in, and thinning parameters are 50000, 1000, and 5, respectively.  

9. **Multivariate probit with different regressors**  

   Let's do a simulation exercise where  
   $$
   \begin{aligned}
   y_{i1}^* &= 0.5 - 1.2x_{i11} + 0.7x_{i12} + 0.8x_{i3} + \mu_{i1}, \\
   y_{i2}^* &= 1.5 - 0.8x_{i21} + 0.5x_{i22} + \mu_{i2},
   \end{aligned}
   $$
   with  
   $$
   \boldsymbol{\Sigma}=
   \begin{bmatrix}
   1 & 0.5 \\
   0.5 & 1
   \end{bmatrix},
   $$
   where all regressors follow a standard normal distribution, and $N=5000$. Use  
   $$
   \boldsymbol{\beta}_0=\boldsymbol{0}, \quad \boldsymbol{B}_0=1000\boldsymbol{B}, \quad \alpha_0=4, \quad \boldsymbol{\Psi}_0=4\boldsymbol{I}_2.
   $$
   Set the number of iterations to 2000 and a thinning parameter equal to 5.  

   - Perform inference using the setting of Section \@ref(sec74), that is, assuming that $x_{i3}$ could have an effect on $y_{i2}$.  
   - Program a Gibbs sampling algorithm taking into account that there are different regressors in each binary decision, that is, $x_{i3}$ does not have an effect on $y_{i2}$.  
